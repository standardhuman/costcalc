<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin - Charge Customer | Sailor Skills</title>
    <link rel="stylesheet" href="style.css">
    <style>
        /* Admin specific styles */
        .admin-badge {
            background: linear-gradient(135deg, #e74c3c, #c0392b);
            color: white;
            padding: 8px 16px;
            font-weight: bold;
            text-align: center;
            position: fixed;
            top: 0;
            right: 20px;
            z-index: 1000;
            border-radius: 0 0 8px 8px;
            box-shadow: 0 2px 10px rgba(231, 76, 60, 0.3);
        }

        /* Customer selector styles matching the main design */
        .customer-section {
            background: white;
            padding: 30px;
            border-radius: 12px;
            box-shadow: 0 8px 32px rgba(0,0,0,0.08);
            margin-bottom: 30px;
            border: 1px solid rgba(0,0,0,0.05);
        }

        .customer-section h3 {
            color: #1e3a5f;
            margin-bottom: 20px;
            font-size: 20px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .customer-section h3::before {
            content: '👥';
            font-size: 24px;
        }

        .customer-controls {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
        }

        .customer-search-input {
            flex: 1;
            padding: 12px 16px;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            font-size: 16px;
            transition: all 0.3s ease;
        }

        .customer-search-input:focus {
            border-color: #3498db;
            outline: none;
            box-shadow: 0 0 0 3px rgba(52, 152, 219, 0.1);
        }

        .customer-btn {
            padding: 12px 24px;
            background: linear-gradient(135deg, #3498db, #2980b9);
            color: white;
            border: none;
            border-radius: 8px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .customer-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(52, 152, 219, 0.3);
        }

        .customer-list {
            max-height: 300px;
            overflow-y: auto;
            border: 2px solid #f0f0f0;
            border-radius: 8px;
            background: #fafafa;
        }

        .customer-item {
            padding: 15px;
            border-bottom: 1px solid #e0e0e0;
            cursor: pointer;
            transition: all 0.3s ease;
            background: white;
        }

        .customer-item:last-child {
            border-bottom: none;
        }

        .customer-item:hover {
            background: linear-gradient(to right, rgba(52, 152, 219, 0.05), rgba(52, 152, 219, 0.02));
        }

        .customer-item.selected {
            background: linear-gradient(135deg, #3498db, #2980b9);
            color: white;
        }

        .customer-name {
            font-weight: 600;
            font-size: 16px;
            margin-bottom: 5px;
        }

        .customer-email {
            font-size: 14px;
            opacity: 0.8;
        }

        .customer-payment {
            display: inline-block;
            margin-top: 5px;
            padding: 3px 8px;
            border-radius: 12px;
            font-size: 12px;
            font-weight: 600;
        }

        .customer-payment.has-card {
            background: rgba(46, 204, 113, 0.2);
            color: #27ae60;
        }

        .customer-payment.no-card {
            background: rgba(231, 76, 60, 0.2);
            color: #e74c3c;
        }

        .customer-item.selected .customer-payment {
            background: rgba(255, 255, 255, 0.3);
            color: white;
        }

        .selected-customer-display {
            margin-top: 20px;
            padding: 15px;
            background: linear-gradient(to right, rgba(52, 152, 219, 0.1), rgba(52, 152, 219, 0.05));
            border-radius: 8px;
            border: 2px solid #3498db;
            display: none;
        }

        .selected-customer-display.active {
            display: block;
        }

        /* Charge summary matching the price display style */
        .charge-summary {
            background: linear-gradient(135deg, #f8f9fa, #e9ecef);
            padding: 25px;
            border-radius: 12px;
            margin-top: 30px;
            border: 2px solid #dee2e6;
        }

        .charge-summary h3 {
            color: #1e3a5f;
            margin-bottom: 20px;
            font-size: 20px;
        }

        .charge-details {
            background: white;
            padding: 20px;
            border-radius: 8px;
            margin-bottom: 20px;
        }

        .charge-detail-row {
            display: flex;
            justify-content: space-between;
            margin-bottom: 10px;
            padding-bottom: 10px;
            border-bottom: 1px solid #e0e0e0;
        }

        .charge-detail-row:last-child {
            border-bottom: none;
            margin-bottom: 0;
            padding-top: 10px;
            font-size: 20px;
            font-weight: bold;
            color: #1e3a5f;
        }

        .charge-button {
            width: 100%;
            padding: 18px;
            background: linear-gradient(135deg, #27ae60, #229954);
            color: white;
            border: none;
            border-radius: 12px;
            font-size: 18px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            position: relative;
            overflow: hidden;
        }

        .charge-button:hover:not(:disabled) {
            transform: translateY(-2px);
            box-shadow: 0 8px 20px rgba(39, 174, 96, 0.3);
        }

        .charge-button:disabled {
            background: #95a5a6;
            cursor: not-allowed;
            transform: none;
        }

        .charge-button.processing {
            background: linear-gradient(135deg, #f39c12, #e67e22);
        }

        /* Result messages */
        .charge-result {
            margin-top: 20px;
            padding: 20px;
            border-radius: 12px;
            display: none;
            animation: slideIn 0.3s ease;
        }

        .charge-result.success {
            background: linear-gradient(135deg, #d4edda, #c3e6cb);
            border: 2px solid #28a745;
            color: #155724;
        }

        .charge-result.error {
            background: linear-gradient(135deg, #f8d7da, #f5c6cb);
            border: 2px solid #dc3545;
            color: #721c24;
        }

        @keyframes slideIn {
            from {
                transform: translateY(-10px);
                opacity: 0;
            }
            to {
                transform: translateY(0);
                opacity: 1;
            }
        }

        .loading-spinner {
            display: inline-block;
            width: 16px;
            height: 16px;
            border: 3px solid rgba(255, 255, 255, 0.3);
            border-radius: 50%;
            border-top-color: white;
            animation: spin 1s ease-in-out infinite;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        .no-customers {
            text-align: center;
            padding: 40px;
            color: #7f8c8d;
        }
        
        /* Boat Configuration Section */
        .boat-config-section {
            background: white;
            padding: 30px;
            border-radius: 12px;
            box-shadow: 0 8px 32px rgba(0,0,0,0.08);
            margin: 30px 0;
            border: 1px solid rgba(0,0,0,0.05);
        }
        
        .boat-config-section h3 {
            color: #1e3a5f;
            margin-bottom: 25px;
            font-size: 20px;
        }
        
        .config-group {
            margin-bottom: 25px;
        }
        
        .config-group label {
            display: block;
            font-weight: 600;
            color: #1e3a5f;
            margin-bottom: 12px;
            font-size: 14px;
        }
        
        .radio-group {
            display: flex;
            gap: 15px;
            flex-wrap: wrap;
        }
        
        .radio-option {
            display: flex;
            align-items: center;
            padding: 12px 20px;
            background: #f8f9fa;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s ease;
            font-weight: normal;
        }
        
        .radio-option:hover {
            background: #e9ecef;
            border-color: #3498db;
        }
        
        .radio-option input[type="radio"] {
            margin-right: 10px;
        }
        
        .radio-option input[type="radio"]:checked + span {
            font-weight: 600;
            color: #3498db;
        }
        
        .radio-option input[type="radio"]:checked {
            accent-color: #3498db;
        }
        
        .radio-option:has(input[type="radio"]:checked) {
            background: linear-gradient(to right, rgba(52, 152, 219, 0.1), rgba(52, 152, 219, 0.05));
            border-color: #3498db;
        }
        
        .checkbox-option {
            display: flex;
            align-items: center;
            padding: 12px 20px;
            background: #f8f9fa;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s ease;
        }
        
        .checkbox-option:hover {
            background: #e9ecef;
            border-color: #3498db;
        }
        
        .checkbox-option input[type="checkbox"] {
            width: 20px;
            height: 20px;
            margin-right: 12px;
            accent-color: #3498db;
        }
        
        .checkbox-option input[type="checkbox"]:checked + span {
            font-weight: 600;
            color: #3498db;
        }
        
        .checkbox-option:has(input[type="checkbox"]:checked) {
            background: linear-gradient(to right, rgba(52, 152, 219, 0.1), rgba(52, 152, 219, 0.05));
            border-color: #3498db;
        }
    </style>
</head>
<body>
    <div class="admin-badge">ADMIN MODE</div>
    
    <div class="container">
        <h1>⚓ Charge Customer for Diving Services</h1>
        <p class="subtitle">Use the same pricing calculator to charge existing customers</p>
        
        <!-- Customer Selector Section -->
        <div class="customer-section">
            <h3>Select Customer</h3>
            <div class="customer-controls">
                <input type="text" 
                       id="customerSearch" 
                       class="customer-search-input"
                       placeholder="Search by name or email...">
                <button onclick="searchCustomers()" class="customer-btn">Search</button>
                <button onclick="loadRecentCustomers()" class="customer-btn">Show Recent</button>
            </div>
            <div id="customerList" class="customer-list">
                <div class="no-customers">Loading customers...</div>
            </div>
            <div id="selectedCustomer" class="selected-customer-display">
                <strong>Selected Customer:</strong> 
                <span id="selectedCustomerInfo"></span>
            </div>
        </div>

        <!-- Service Calculator (reusing existing elements) -->
        <div class="service-selector">
            <h3>Select Service Type</h3>
            <div class="service-selection-grid" id="serviceButtons">
                <!-- Service buttons will be populated by JS -->
            </div>
            <p class="variable-info" id="servicePriceExplainer" style="margin-top: 15px;">Select a service to see its description.</p>
        </div>
        
        <!-- Boat Configuration Section (visible for cleaning services) -->
        <div id="boatConfigSection" class="boat-config-section" style="display: none;">
            <h3>⛵ Boat Configuration</h3>
            
            <div class="config-group">
                <label>Boat Type</label>
                <div class="radio-group">
                    <label class="radio-option">
                        <input type="radio" name="boat_type" value="sailboat" checked onchange="updateBoatConfig()">
                        <span>Sailboat</span>
                    </label>
                    <label class="radio-option">
                        <input type="radio" name="boat_type" value="powerboat" onchange="updateBoatConfig()">
                        <span>Powerboat (+25% surcharge)</span>
                    </label>
                </div>
            </div>
            
            <div class="config-group">
                <label>Hull Type</label>
                <div class="radio-group">
                    <label class="radio-option">
                        <input type="radio" name="hull_type" value="monohull" checked onchange="updateBoatConfig()">
                        <span>Monohull</span>
                    </label>
                    <label class="radio-option">
                        <input type="radio" name="hull_type" value="catamaran" onchange="updateBoatConfig()">
                        <span>Catamaran (+25% surcharge)</span>
                    </label>
                    <label class="radio-option">
                        <input type="radio" name="hull_type" value="trimaran" onchange="updateBoatConfig()">
                        <span>Trimaran (+50% surcharge)</span>
                    </label>
                </div>
            </div>
            
            <div class="config-group">
                <label>Engine Configuration</label>
                <div class="checkbox-group">
                    <label class="checkbox-option">
                        <input type="checkbox" id="has_twin_engines" name="has_twin_engines" value="true" onchange="updateBoatConfig()">
                        <span>Twin engines (+10% surcharge)</span>
                    </label>
                </div>
            </div>
        </div>
        
        <!-- Hidden step elements for calculator compatibility -->
        <div style="display: none;">
            <div id="step-0" class="form-step active"></div>
            <div id="step-1" class="form-step">
                <input type="number" id="dummy-boatLength" value="35">
            </div>
            <div id="step-2" class="form-step"></div>
            <div id="step-3" class="form-step"></div>
            <div id="step-4" class="form-step"></div>
            <div id="step-5" class="form-step">
                <select id="hiddenLastPaintedTime">
                    <option value="0-1">0-1 years</option>
                    <option value="1-2" selected>1-2 years</option>
                    <option value="2-3">2-3 years</option>
                    <option value="3+">3+ years</option>
                </select>
            </div>
            <div id="step-6" class="form-step">
                <select id="hiddenLastCleanedTime">
                    <option value="0-3">0-3 months</option>
                    <option value="3-6" selected>3-6 months</option>
                    <option value="6-9">6-9 months</option>
                    <option value="9+">9+ months</option>
                </select>
            </div>
            <div id="step-7" class="form-step">
                <input type="number" id="anodesToInstall" value="0">
            </div>
            <div id="step-8" class="result-section form-step">
                <div id="hiddenCostBreakdown" style="display: none;"></div>
                <div class="total-row">
                    <span class="total-label">Total:</span>
                    <span class="total-value" id="hiddenTotalCostDisplay">$0</span>
                </div>
            </div>
        </div>

        <div class="boat-details">
            <h3>Boat Details</h3>
            <div class="input-group">
                <label for="boatLength">Boat Length (feet)</label>
                <input type="number" id="boatLength" min="20" max="100" value="35" required>
            </div>
            
            <div id="cleaningOptions">
                <div class="input-group">
                    <label for="actualPaintCondition">Actual Paint Condition Found</label>
                    <select id="actualPaintCondition">
                        <option value="excellent" selected>Excellent</option>
                        <option value="good">Good</option>
                        <option value="fair">Fair</option>
                        <option value="poor">Poor</option>
                        <option value="missing">Missing</option>
                    </select>
                </div>
                
                <div class="input-group">
                    <label for="actualGrowthLevel">Actual Growth Level Found</label>
                    <select id="actualGrowthLevel">
                        <option value="minimal" selected>Minimal - Thin film</option>
                        <option value="moderate">Moderate - Visible growth</option>
                        <option value="heavy">Heavy - Thick growth</option>
                        <option value="severe">Severe - Barnacles/heavy fouling</option>
                    </select>
                </div>
            </div>
        </div>

        <div class="pricing-display" id="pricingDisplay">
            <h3>Service Total</h3>
            <div class="price-breakdown" id="priceBreakdown">
                <pre id="costBreakdown" style="font-family: inherit; white-space: pre-wrap; margin: 10px 0;"></pre>
                <div class="total-row" style="font-size: 20px; font-weight: bold; color: #1e3a5f; margin-top: 15px; padding-top: 15px; border-top: 2px solid #dee2e6;">
                    <span class="total-label">Total:</span>
                    <span class="total-value" id="totalCostDisplay">$0</span>
                </div>
            </div>
        </div>

        <!-- Charge Summary Section -->
        <div class="charge-summary">
            <h3>💳 Charge Summary</h3>
            <div class="charge-details" id="chargeDetails">
                <div style="text-align: center; color: #7f8c8d;">
                    Select a customer and configure service details
                </div>
            </div>
            <button id="chargeButton" class="charge-button" onclick="chargeCustomer()" disabled>
                Charge Customer
            </button>
        </div>

        <!-- Result Display -->
        <div id="chargeResult" class="charge-result"></div>
    </div>

    <script src="script.js" type="module"></script>
    <script type="module">
        let selectedCustomer = null;
        let customers = [];

        // Wait for script.js to load completely
        function initializePage() {
            // Populate service buttons from script.js
            if (window.populateServiceButtons) {
                window.populateServiceButtons();
            } else {
                // Retry if not loaded yet
                setTimeout(initializePage, 100);
                return;
            }
            
            // Set up a watcher for service selection changes
            setInterval(() => {
                const serviceKey = window.selectedServiceKey || window.getSelectedServiceKey?.();
                updateBoatConfigVisibility(serviceKey);
            }, 100);
            
            // Set up event listeners for the calculator
            document.getElementById('boatLength').addEventListener('input', function() {
                // Sync with hidden field for calculator
                const hiddenLength = document.getElementById('dummy-boatLength');
                if (hiddenLength) hiddenLength.value = this.value;
                
                if (window.calculateCost) {
                    window.calculateCost();
                }
                updateChargeSummary();
            });
            
            document.getElementById('actualPaintCondition')?.addEventListener('change', function() {
                if (window.calculateCostDirect) {
                    window.calculateCostDirect();
                } else if (window.calculateCost) {
                    window.calculateCost();
                }
                updateChargeSummary();
            });
            
            document.getElementById('actualGrowthLevel')?.addEventListener('change', function() {
                if (window.calculateCostDirect) {
                    window.calculateCostDirect();
                } else if (window.calculateCost) {
                    window.calculateCost();
                }
                updateChargeSummary();
            });

            // Add enter key support for search
            document.getElementById('customerSearch').addEventListener('keypress', function(e) {
                if (e.key === 'Enter') {
                    searchCustomers();
                }
            });
            
            // Initial calculations
            if (window.calculateCost) {
                window.calculateCost();
            }
            loadRecentCustomers();
        }
        
        // Initialize on page load
        document.addEventListener('DOMContentLoaded', function() {
            initializePage();
        });

        // Load recent customers
        async function loadRecentCustomers() {
            const listEl = document.getElementById('customerList');
            listEl.innerHTML = '<div class="no-customers">Loading customers...</div>';
            
            try {
                const response = await fetch('http://localhost:3001/api/stripe-customers?limit=10');
                const data = await response.json();
                customers = data.customers || [];
                displayCustomers(customers);
            } catch (error) {
                console.error('Error loading customers:', error);
                listEl.innerHTML = '<div class="no-customers">Error loading customers. Check console.</div>';
            }
        }
        
        // Make functions globally available
        window.loadRecentCustomers = loadRecentCustomers;

        // Search customers
        async function searchCustomers() {
            const query = document.getElementById('customerSearch').value.trim();
            if (!query) {
                loadRecentCustomers();
                return;
            }

            const listEl = document.getElementById('customerList');
            listEl.innerHTML = '<div class="no-customers">Searching...</div>';

            try {
                const response = await fetch(`http://localhost:3001/api/stripe-customers?search=${encodeURIComponent(query)}`);
                const data = await response.json();
                customers = data.customers || [];
                displayCustomers(customers);
            } catch (error) {
                console.error('Error searching customers:', error);
                listEl.innerHTML = '<div class="no-customers">Error searching. Check console.</div>';
            }
        }
        
        // Make functions globally available
        window.searchCustomers = searchCustomers;

        // Display customer list
        function displayCustomers(customerList) {
            const listEl = document.getElementById('customerList');
            
            if (!customerList || customerList.length === 0) {
                listEl.innerHTML = '<div class="no-customers">No customers found</div>';
                return;
            }

            listEl.innerHTML = customerList.map(customer => `
                <div class="customer-item" onclick="selectCustomer('${customer.id}', event)">
                    <div class="customer-name">${customer.name || 'Unnamed Customer'}</div>
                    <div class="customer-email">${customer.email}</div>
                    <span class="customer-payment ${customer.payment_method ? 'has-card' : 'no-card'}">
                        ${customer.payment_method ? '✓ Card on file' : '✗ No payment method'}
                    </span>
                </div>
            `).join('');

            // Re-select if a customer was already selected
            if (selectedCustomer) {
                const selectedEl = document.querySelector(`[onclick*="${selectedCustomer.id}"]`);
                if (selectedEl) {
                    selectedEl.classList.add('selected');
                }
            }
        }

        // Select a customer
        function selectCustomer(customerId, event) {
            selectedCustomer = customers.find(c => c.id === customerId);
            
            if (!selectedCustomer) return;
            
            // Update UI
            document.querySelectorAll('.customer-item').forEach(el => {
                el.classList.remove('selected');
            });
            
            if (event && event.currentTarget) {
                event.currentTarget.classList.add('selected');
            }
            
            // Show selected customer info
            const selectedDisplay = document.getElementById('selectedCustomer');
            selectedDisplay.classList.add('active');
            document.getElementById('selectedCustomerInfo').textContent = 
                `${selectedCustomer.name || 'Unnamed'} (${selectedCustomer.email}) - ${
                    selectedCustomer.payment_method ? 'Card ending in ' + selectedCustomer.payment_method.card.last4 : 'No card on file'
                }`;
            
            updateChargeSummary();
        }
        
        // Make selectCustomer globally available
        window.selectCustomer = selectCustomer;
        
        // Update boat configuration and recalculate
        function updateBoatConfig() {
            if (window.calculateCost) {
                window.calculateCost();
            }
            updateChargeSummary();
        }
        
        window.updateBoatConfig = updateBoatConfig;
        
        // Function to update boat config visibility
        function updateBoatConfigVisibility(serviceKey) {
            const boatConfigSection = document.getElementById('boatConfigSection');
            const boatDetails = document.querySelector('.boat-details');
            const cleaningOptions = document.getElementById('cleaningOptions');
            
            const isCleaningService = serviceKey === 'onetime_cleaning' || serviceKey === 'recurring_cleaning';
            
            if (boatConfigSection) {
                const currentDisplay = boatConfigSection.style.display;
                const newDisplay = isCleaningService ? 'block' : 'none';
                if (currentDisplay !== newDisplay) {
                    boatConfigSection.style.display = newDisplay;
                    console.log('Updated boat config visibility:', newDisplay, 'for service:', serviceKey);
                }
            }
            if (boatDetails) {
                boatDetails.style.display = 'block'; // Always show boat length
            }
            if (cleaningOptions) {
                cleaningOptions.style.display = isCleaningService ? 'block' : 'none';
            }
        }
        
        // Also listen for clicks on service buttons directly
        document.addEventListener('click', function(e) {
            if (e.target.closest('.service-option')) {
                const serviceKey = e.target.closest('.service-option').dataset.serviceKey;
                if (serviceKey) {
                    setTimeout(() => updateBoatConfigVisibility(serviceKey), 50);
                }
            }
        });

        // Update charge summary
        function updateChargeSummary() {
            const chargeDetails = document.getElementById('chargeDetails');
            const chargeButton = document.getElementById('chargeButton');
            
            if (!selectedCustomer) {
                chargeDetails.innerHTML = `
                    <div style="text-align: center; color: #7f8c8d;">
                        Select a customer and configure service details
                    </div>
                `;
                chargeButton.disabled = true;
                return;
            }

            // Get price from the results section (total value)
            // The totalCostDisplay element directly holds the value
            const totalElement = document.getElementById('totalCostDisplay');
            const price = totalElement ? parseFloat(totalElement.textContent.replace('$', '').replace(',', '')) : 0;
            
            // Get selected service from the service buttons
            const selectedServiceEl = document.querySelector('.service-option.selected');
            const serviceTitleEl = selectedServiceEl ? selectedServiceEl.querySelector('.service-title') : null;
            const serviceName = serviceTitleEl ? serviceTitleEl.textContent : '';

            chargeDetails.innerHTML = `
                <div class="charge-detail-row">
                    <span>Customer:</span>
                    <span>${selectedCustomer.name || 'Unnamed'}</span>
                </div>
                <div class="charge-detail-row">
                    <span>Email:</span>
                    <span>${selectedCustomer.email}</span>
                </div>
                <div class="charge-detail-row">
                    <span>Payment Method:</span>
                    <span style="color: ${selectedCustomer.payment_method ? '#27ae60' : '#e74c3c'}">
                        ${selectedCustomer.payment_method ? 
                            `Card ending in ${selectedCustomer.payment_method.card.last4}` : 
                            'No card on file'}
                    </span>
                </div>
                <div class="charge-detail-row">
                    <span>Service:</span>
                    <span>${serviceName}</span>
                </div>
                <div class="charge-detail-row">
                    <span>Total Amount:</span>
                    <span>
                        $<input type="number" 
                               id="editableAmount" 
                               value="${price.toFixed(2)}" 
                               step="0.01" 
                               min="0" 
                               style="width: 100px; border: 1px solid #ddd; padding: 4px; border-radius: 4px;"
                               oninput="updateChargeButton()">
                    </span>
                </div>
            `;
            
            // Update charge button based on editable amount
            const editableAmount = parseFloat(document.getElementById('editableAmount')?.value || 0);
            chargeButton.disabled = !selectedCustomer.payment_method || editableAmount === 0;
            chargeButton.textContent = selectedCustomer.payment_method ? 
                `Charge $${editableAmount.toFixed(2)}` : 'No Payment Method Available';
        }

        // Charge the customer
        async function chargeCustomer() {
            if (!selectedCustomer || !selectedCustomer.payment_method) {
                alert('Please select a customer with a payment method on file');
                return;
            }

            const button = document.getElementById('chargeButton');
            const originalText = button.innerHTML;
            button.innerHTML = 'Processing... <span class="loading-spinner"></span>';
            button.classList.add('processing');
            button.disabled = true;

            // Get price from the editable amount field if it exists, otherwise from totalCostDisplay
            const editableAmountEl = document.getElementById('editableAmount');
            let price;
            if (editableAmountEl) {
                price = parseFloat(editableAmountEl.value) || 0;
            } else {
                const totalElement = document.getElementById('totalCostDisplay');
                price = totalElement ? parseFloat(totalElement.textContent.replace('$', '').replace(',', '')) : 0;
            }
            
            // Get selected service key
            const selectedServiceEl = document.querySelector('.service-option.selected');
            const service = selectedServiceEl ? selectedServiceEl.dataset.serviceKey : '';
            const boatLength = document.getElementById('boatLength').value;

            // Build metadata based on service type
            const metadata = { service: service };
            
            // Only include boat details for cleaning services
            const isCleaningService = service === 'onetime_cleaning' || service === 'recurring_cleaning';
            const isFlatRateService = service === 'item_recovery' || service === 'underwater_inspection';
            
            if (isCleaningService) {
                metadata.boat_length = boatLength;
                metadata.last_paint = document.getElementById('lastPaintedTime')?.value;
                metadata.last_cleaned = document.getElementById('lastCleanedTime')?.value;
                
                // Add hull type and engine configuration if available
                const hullType = document.querySelector('input[name="hull_type"]:checked')?.value;
                if (hullType) {
                    metadata.hull_type = hullType;
                    if (hullType === 'catamaran') metadata.additional_hulls = 1;
                    if (hullType === 'trimaran') metadata.additional_hulls = 2;
                }
                
                const hasTwinEngines = document.getElementById('has_twin_engines')?.checked;
                if (hasTwinEngines) {
                    metadata.twin_engines = true;
                    metadata.engine_type = 'twin';
                } else {
                    metadata.engine_type = 'single';
                }
                
                // Add boat type (sailboat/powerboat)
                const boatType = document.querySelector('input[name="boat_type"]:checked')?.value;
                if (boatType) {
                    metadata.boat_type = boatType;
                }
            }
            
            // Build appropriate description
            let description = service.replace(/_/g, ' ');
            if (!isFlatRateService && boatLength) {
                description += ` - ${boatLength}ft boat`;
            }

            try {
                const response = await fetch('http://localhost:3001/api/charge-customer', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        customerId: selectedCustomer.id,
                        amount: Math.round(price * 100), // Convert to cents
                        description: description,
                        metadata: metadata
                    })
                });

                const result = await response.json();
                
                if (result.success) {
                    showResult('success', 
                        `✅ Successfully charged $${price.toFixed(2)} to ${selectedCustomer.name || selectedCustomer.email}<br>
                         Payment ID: ${result.paymentIntent.id}`);
                    
                    // Reset selection after success
                    setTimeout(() => {
                        selectedCustomer = null;
                        document.getElementById('selectedCustomer').classList.remove('active');
                        document.querySelectorAll('.customer-item').forEach(el => {
                            el.classList.remove('selected');
                        });
                        updateChargeSummary();
                    }, 3000);
                } else {
                    showResult('error', `❌ Payment failed: ${result.error}`);
                }
            } catch (error) {
                showResult('error', `❌ Error processing payment: ${error.message}`);
            } finally {
                button.innerHTML = originalText;
                button.classList.remove('processing');
                updateChargeSummary();
            }
        }
        
        // Update charge button when amount is edited
        function updateChargeButton() {
            const editableAmount = parseFloat(document.getElementById('editableAmount')?.value || 0);
            const chargeButton = document.getElementById('chargeButton');
            
            if (selectedCustomer && selectedCustomer.payment_method) {
                chargeButton.disabled = editableAmount === 0;
                chargeButton.textContent = `Charge $${editableAmount.toFixed(2)}`;
            }
        }
        
        // Make functions globally available
        window.chargeCustomer = chargeCustomer;
        window.updateChargeSummary = updateChargeSummary;
        window.updateChargeButton = updateChargeButton;

        // Show result message
        function showResult(type, message) {
            const resultEl = document.getElementById('chargeResult');
            resultEl.className = `charge-result ${type}`;
            resultEl.innerHTML = message;
            resultEl.style.display = 'block';
            
            setTimeout(() => {
                resultEl.style.display = 'none';
            }, 5000);
        }
    </script>
</body>
</html>
