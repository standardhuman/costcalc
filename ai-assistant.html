<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI Inventory Assistant</title>
    <link rel="stylesheet" href="inventory.css">
    <link rel="stylesheet" href="ai-assistant.css">
</head>
<body>
    <div class="container">
        <header>
            <h1>ü§ñ AI Inventory Assistant</h1>
            <nav>
                <button class="nav-btn" onclick="window.location.href='inventory.html'">‚Üê Back to Inventory</button>
                <button class="nav-btn active">AI Assistant</button>
                <button class="nav-btn" id="clear-chat">Clear Chat</button>
                <button class="nav-btn" id="api-settings">API Settings</button>
            </nav>
        </header>

        <div class="ai-assistant-container">
            <!-- Chat Messages Area -->
            <div class="chat-area">
                <div id="chat-messages" class="chat-messages">
                    <!-- Welcome Message -->
                    <div class="message assistant-message">
                        <div class="message-avatar">ü§ñ</div>
                        <div class="message-content">
                            <p>Hi! I'm your AI Inventory Assistant. I can help you add items to your inventory by analyzing screenshots of:</p>
                            <ul>
                                <li>üì¶ Order confirmations</li>
                                <li>üõí Product listings</li>
                                <li>üìÑ Invoices and receipts</li>
                                <li>üìã Packing lists</li>
                            </ul>
                            <p>Just drag and drop or paste an image below, and I'll extract the product details for you!</p>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Input Area -->
            <div class="input-area">
                <div id="drop-zone" class="drop-zone">
                    <div class="drop-zone-content">
                        <svg class="upload-icon" width="64" height="64" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path>
                            <polyline points="17 8 12 3 7 8"></polyline>
                            <line x1="12" y1="3" x2="12" y2="15"></line>
                        </svg>
                        <p class="drop-text">Drag & drop images here or click to browse</p>
                        <p class="drop-hint">Supports PNG, JPG, WEBP (max 20MB)</p>
                        <input type="file" id="file-input" accept="image/*" multiple hidden>
                        <button class="btn btn-primary" id="browse-btn">Choose Files</button>
                    </div>
                </div>

                <!-- Image Preview Area -->
                <div id="image-preview" class="image-preview hidden">
                    <div class="preview-header">
                        <span class="preview-title">Selected Images</span>
                        <button class="btn-remove" id="clear-images">Clear All</button>
                    </div>
                    <div id="preview-grid" class="preview-grid"></div>
                    <button class="btn btn-primary" id="process-images">
                        <span class="btn-text">Process Images</span>
                        <span class="spinner hidden"></span>
                    </button>
                </div>

                <!-- Quick Actions -->
                <div class="quick-actions">
                    <button class="quick-action" data-prompt="extract-all">
                        üì¶ Extract All Products
                    </button>
                    <button class="quick-action" data-prompt="extract-anodes">
                        ‚öì Extract Anodes Only
                    </button>
                    <button class="quick-action" data-prompt="extract-prices">
                        üí∞ Focus on Prices
                    </button>
                    <button class="quick-action" data-prompt="extract-quantities">
                        üìä Focus on Quantities
                    </button>
                </div>
            </div>
        </div>

        <!-- Extracted Data Modal -->
        <div id="data-modal" class="modal">
            <div class="modal-content modal-xl">
                <div class="modal-header">
                    <h2>Review Extracted Data</h2>
                    <span class="close">&times;</span>
                </div>
                <div class="modal-body">
                    <div class="extraction-summary">
                        <span id="items-count">0 items found</span>
                        <button class="btn btn-secondary" id="add-manual-row">+ Add Row</button>
                    </div>

                    <div class="data-table-wrapper">
                        <table class="extracted-data-table">
                            <thead>
                                <tr>
                                    <th><input type="checkbox" id="select-all-items" checked></th>
                                    <th>Name*</th>
                                    <th>SKU</th>
                                    <th>Quantity</th>
                                    <th>Price</th>
                                    <th>Category</th>
                                    <th>Supplier</th>
                                    <th>Description</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody id="extracted-data-rows">
                                <!-- Data rows will be inserted here -->
                            </tbody>
                        </table>
                    </div>

                    <div class="import-options">
                        <label>
                            <input type="checkbox" id="auto-match-catalog" checked>
                            Auto-match with existing catalog
                        </label>
                        <label>
                            <input type="checkbox" id="add-to-replenishment">
                            Add to replenishment list if low stock
                        </label>
                    </div>

                    <div class="modal-actions">
                        <button class="btn btn-primary" id="confirm-import">
                            <span>Import Selected Items</span>
                            <span id="import-count">(0)</span>
                        </button>
                        <button class="btn btn-secondary" id="save-draft">Save as Draft</button>
                        <button class="btn btn-secondary" id="cancel-import">Cancel</button>
                    </div>
                </div>
            </div>
        </div>

        <!-- API Settings Modal -->
        <div id="settings-modal" class="modal">
            <div class="modal-content">
                <div class="modal-header">
                    <h2>API Settings</h2>
                    <span class="close">&times;</span>
                </div>
                <div class="modal-body">
                    <form id="settings-form">
                        <div class="form-group">
                            <label>Gemini API Key:*</label>
                            <input type="password" id="gemini-api-key" placeholder="Enter your Gemini API key">
                            <small>Get your free API key from <a href="https://aistudio.google.com/app/apikey" target="_blank">Google AI Studio</a></small>
                            <button type="button" class="btn btn-secondary" onclick="aiAssistant.testApiKey()" style="margin-top: 8px">Test API Key</button>
                        </div>

                        <div class="form-group">
                            <label>Model:</label>
                            <select id="gemini-model">
                                <option value="gemini-1.5-flash" selected>Gemini 1.5 Flash (Recommended)</option>
                                <option value="gemini-1.5-flash-8b">Gemini 1.5 Flash 8B</option>
                                <option value="gemini-1.5-pro">Gemini 1.5 Pro</option>
                            </select>
                        </div>

                        <div class="form-group">
                            <label>Default Extraction Mode:</label>
                            <select id="extraction-mode">
                                <option value="comprehensive">Comprehensive (All details)</option>
                                <option value="essential">Essential (Key fields only)</option>
                                <option value="quick">Quick (Name & quantity)</option>
                            </select>
                        </div>

                        <div class="form-group">
                            <label>
                                <input type="checkbox" id="auto-process" checked>
                                Automatically process images after upload
                            </label>
                        </div>

                        <div class="form-group">
                            <label>
                                <input type="checkbox" id="save-history">
                                Save extraction history
                            </label>
                        </div>

                        <div class="api-usage">
                            <h4>Usage Today</h4>
                            <div class="usage-stats">
                                <div class="usage-stat">
                                    <span class="usage-label">Requests:</span>
                                    <span class="usage-value"><span id="requests-used">0</span> / 25</span>
                                </div>
                                <div class="usage-bar">
                                    <div class="usage-fill" id="usage-bar" style="width: 0%"></div>
                                </div>
                                <small>Resets at midnight PT</small>
                            </div>
                        </div>

                        <div class="form-actions">
                            <button type="submit" class="btn btn-primary">Save Settings</button>
                            <button type="button" class="btn btn-secondary" onclick="aiAssistant.closeModal()">Cancel</button>
                        </div>
                    </form>
                </div>
            </div>
        </div>

        <!-- Processing Overlay -->
        <div id="processing-overlay" class="processing-overlay hidden">
            <div class="processing-content">
                <div class="processing-spinner"></div>
                <h3>Processing Images...</h3>
                <p id="processing-status">Extracting product information</p>
                <div class="processing-progress">
                    <div class="progress-bar">
                        <div class="progress-fill" id="progress-fill" style="width: 0%"></div>
                    </div>
                    <span id="progress-text">0 / 0</span>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script>
        // Set Supabase credentials (inherited from main inventory system)
        window.SUPABASE_URL = 'https://fzygakldvvzxmahkdylq.supabase.co';
        window.SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImZ6eWdha2xkdnZ6eG1haGtkeWxxIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTQwODM4OTgsImV4cCI6MjA2OTY1OTg5OH0.8BNDF5zmpk2HFdprTjsdOWTDh_XkAPdTnGo7omtiVIk';
    </script>
    <script src="gemini-service.js"></script>
    <script src="ai-assistant.js"></script>
</body>
</html>