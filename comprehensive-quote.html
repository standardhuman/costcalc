<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Service Quote | Sailor Skills</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="style.css">
    <style>
        /* Quote specific styles */
        body {
            background-color: #ffffff;
            min-height: 100vh;
            font-family: 'Montserrat', sans-serif;
            margin: 0;
            padding: 0;
            color: #181818;
        }
        
        .quote-header {
            background-color: #345475;
            color: white;
            padding: 20px;
            text-align: center;
            border-bottom: 3px solid #2a4460;
        }
        
        .quote-header h1 {
            margin: 0;
            font-size: 28px;
            font-weight: 600;
        }
        
        .quote-container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 30px 20px;
        }
        
        .quote-info {
            background: #f9f9f9;
            border-radius: 8px;
            padding: 20px;
            margin-bottom: 30px;
        }
        
        .quote-info-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-top: 15px;
        }
        
        .info-item {
            display: flex;
            flex-direction: column;
        }
        
        .info-label {
            font-weight: 600;
            color: #666;
            font-size: 12px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            margin-bottom: 5px;
        }
        
        .info-value {
            font-size: 16px;
            color: #333;
            border: 1px solid #ddd;
            padding: 8px;
            border-radius: 3px;
            background: white;
        }
        
        /* Service selection */
        .services-section {
            margin-bottom: 30px;
            background: white;
            border: 1px solid #ddd;
            border-radius: 8px;
            padding: 20px;
        }
        
        .services-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 15px;
            margin-top: 15px;
        }
        
        .service-card {
            border: 2px solid #ddd;
            border-radius: 5px;
            padding: 15px;
            cursor: pointer;
            transition: all 0.3s;
            background: white;
        }
        
        .service-card:hover {
            border-color: #345475;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }
        
        .service-card.selected {
            border-color: #345475;
            background: #f0f7ff;
        }
        
        .service-name {
            font-weight: 600;
            color: #333;
            margin-bottom: 5px;
        }
        
        .service-price {
            color: #345475;
            font-size: 14px;
            margin-bottom: 8px;
        }
        
        .service-description {
            font-size: 12px;
            color: #666;
            line-height: 1.4;
        }
        
        /* Service Options */
        .service-options {
            margin-top: 20px;
            padding: 15px;
            background: #f9f9f9;
            border-radius: 5px;
        }
        
        .option-group {
            margin-bottom: 15px;
        }
        
        .option-label {
            font-weight: 600;
            margin-bottom: 8px;
            display: block;
        }
        
        .radio-group, .checkbox-group {
            display: flex;
            gap: 15px;
            flex-wrap: wrap;
        }
        
        .radio-item, .checkbox-item {
            display: flex;
            align-items: center;
            gap: 5px;
        }
        
        /* Anode section */
        .anodes-section {
            margin-bottom: 30px;
            background: white;
            border: 1px solid #ddd;
            border-radius: 8px;
            padding: 20px;
        }
        
        .section-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
            padding-bottom: 10px;
            border-bottom: 2px solid #345475;
        }
        
        .section-title {
            font-size: 20px;
            font-weight: 600;
            color: #345475;
        }
        
        .toggle-section {
            padding: 8px 15px;
            background: #345475;
            color: white;
            border: none;
            border-radius: 3px;
            cursor: pointer;
            font-size: 14px;
        }
        
        .toggle-section:hover {
            background: #2a4460;
        }
        
        .category-filters {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
            margin-bottom: 15px;
        }
        
        .category-btn {
            padding: 8px 15px;
            background: white;
            border: 1px solid #345475;
            border-radius: 3px;
            cursor: pointer;
            font-size: 13px;
            transition: all 0.2s;
        }
        
        .category-btn:hover {
            background: #f0f4f8;
        }
        
        .category-btn.active {
            background: #345475;
            color: white;
        }
        
        .anode-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
            gap: 10px;
            max-height: 300px;
            overflow-y: auto;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 5px;
            background: #fafafa;
        }
        
        .anode-item {
            background: white;
            border: 1px solid #ddd;
            border-radius: 3px;
            padding: 10px;
            font-size: 13px;
        }
        
        .anode-name {
            font-weight: 500;
            margin-bottom: 5px;
            font-size: 12px;
        }
        
        .anode-controls {
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .anode-price {
            color: #345475;
            font-weight: 600;
        }
        
        .quantity-controls {
            display: flex;
            align-items: center;
            gap: 5px;
        }
        
        .quantity-btn {
            width: 24px;
            height: 24px;
            border: 1px solid #345475;
            background: white;
            border-radius: 2px;
            cursor: pointer;
            font-size: 14px;
        }
        
        .quantity-btn:hover {
            background: #345475;
            color: white;
        }
        
        .quantity-display {
            min-width: 20px;
            text-align: center;
            font-weight: 600;
        }
        
        /* Quote summary */
        .quote-summary {
            background: white;
            border: 2px solid #345475;
            border-radius: 8px;
            padding: 25px;
            margin-top: 30px;
        }
        
        .quote-summary h2 {
            margin-top: 0;
            color: #345475;
            border-bottom: 2px solid #eee;
            padding-bottom: 15px;
        }
        
        .summary-section {
            margin: 20px 0;
            padding: 15px 0;
            border-bottom: 1px solid #eee;
        }
        
        .summary-section:last-child {
            border-bottom: none;
        }
        
        .summary-title {
            font-weight: 600;
            color: #666;
            margin-bottom: 10px;
            font-size: 14px;
            text-transform: uppercase;
        }
        
        .quote-item {
            display: flex;
            justify-content: space-between;
            padding: 8px 0;
            font-size: 15px;
        }
        
        .quote-totals {
            margin-top: 20px;
            padding-top: 20px;
            border-top: 2px solid #345475;
        }
        
        .total-row {
            display: flex;
            justify-content: space-between;
            padding: 10px 0;
            font-size: 16px;
        }
        
        .total-row.subtotal {
            font-weight: 600;
            color: #333;
        }
        
        .total-row.grand-total {
            font-size: 22px;
            font-weight: 700;
            color: #345475;
            border-top: 2px solid #345475;
            margin-top: 10px;
            padding-top: 15px;
        }
        
        /* Action buttons */
        .quote-actions {
            display: flex;
            gap: 15px;
            margin-top: 30px;
            justify-content: center;
        }
        
        .action-btn {
            padding: 15px 30px;
            font-size: 16px;
            font-weight: 600;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            transition: all 0.3s;
        }
        
        .btn-primary {
            background: #345475;
            color: white;
        }
        
        .btn-primary:hover {
            background: #2a4460;
        }
        
        .btn-secondary {
            background: white;
            color: #345475;
            border: 2px solid #345475;
        }
        
        .btn-secondary:hover {
            background: #f0f4f8;
        }
        
        .collapsed {
            display: none;
        }
        
        /* Print styles */
        @media print {
            .category-filters,
            .quote-actions,
            .toggle-section,
            .anode-grid {
                display: none !important;
            }
            
            .quote-header {
                background: none;
                color: black;
                border-bottom: 2px solid black;
            }
            
            .anodes-summary {
                display: block !important;
            }
        }
        
        .anodes-summary {
            display: none;
        }
        
        @media print {
            .anodes-summary {
                display: block;
            }
        }
    </style>
</head>
<body>
    <div class="quote-header">
        <h1>🚤 Comprehensive Service Quote</h1>
    </div>
    
    <div class="quote-container">
        <!-- Customer Information -->
        <div class="quote-info">
            <h2>Quote Information</h2>
            <div class="quote-info-grid">
                <div class="info-item">
                    <span class="info-label">Date</span>
                    <input type="text" id="quoteDate" class="info-value" readonly>
                </div>
                <div class="info-item">
                    <span class="info-label">Quote #</span>
                    <input type="text" id="quoteNumber" class="info-value" readonly>
                </div>
                <div class="info-item">
                    <span class="info-label">Customer</span>
                    <input type="text" id="customerName" class="info-value" placeholder="Enter customer name">
                </div>
                <div class="info-item">
                    <span class="info-label">Boat Name</span>
                    <input type="text" id="boatName" class="info-value" placeholder="Enter boat name">
                </div>
                <div class="info-item">
                    <span class="info-label">Boat Length (ft)</span>
                    <input type="number" id="boatLength" class="info-value" placeholder="Length" min="1" max="200" onchange="updateServicePrices()">
                </div>
                <div class="info-item">
                    <span class="info-label">Marina</span>
                    <input type="text" id="marina" class="info-value" placeholder="Marina name">
                </div>
            </div>
        </div>
        
        <!-- Services Section -->
        <div class="services-section">
            <div class="section-header">
                <span class="section-title">⚓ Diving Services</span>
            </div>
            
            <div class="services-grid">
                <div class="service-card" data-service="recurring_cleaning">
                    <div class="service-name">Recurring Cleaning</div>
                    <div class="service-price">$4.50/ft</div>
                    <div class="service-description">Regular hull cleaning with anode inspection</div>
                </div>
                
                <div class="service-card" data-service="onetime_cleaning">
                    <div class="service-name">One-time Cleaning</div>
                    <div class="service-price">$6.00/ft</div>
                    <div class="service-description">Complete hull cleaning and inspection</div>
                </div>
                
                <div class="service-card" data-service="underwater_inspection">
                    <div class="service-name">Underwater Inspection</div>
                    <div class="service-price">$4.00/ft ($150 min)</div>
                    <div class="service-description">Detailed inspection with photos/video</div>
                </div>
                
                <div class="service-card" data-service="item_recovery">
                    <div class="service-name">Item Recovery</div>
                    <div class="service-price">$199 flat</div>
                    <div class="service-description">Recovery of dropped items (45 min search)</div>
                </div>
                
                <div class="service-card" data-service="propeller_service">
                    <div class="service-name">Propeller Service</div>
                    <div class="service-price">$349/propeller</div>
                    <div class="service-description">Removal or installation service</div>
                </div>
            </div>
            
            <div class="service-options" id="serviceOptions" style="display: none;">
                <!-- Options will be populated based on selected service -->
            </div>
        </div>
        
        <!-- Anodes Section -->
        <div class="anodes-section">
            <div class="section-header">
                <span class="section-title">🔧 Zinc Anodes</span>
                <button class="toggle-section" onclick="toggleAnodeSection()">Show/Hide</button>
            </div>
            
            <div id="anodeContent" class="collapsed">
                <div class="category-filters">
                    <button class="category-btn active" onclick="filterAnodes('all')">All</button>
                    <button class="category-btn" onclick="filterAnodes('shaft')">Shaft</button>
                    <button class="category-btn" onclick="filterAnodes('hull')">Hull</button>
                    <button class="category-btn" onclick="filterAnodes('engine')">Engine</button>
                    <button class="category-btn" onclick="filterAnodes('propeller')">Propeller</button>
                    <button class="category-btn" onclick="filterAnodes('rudder')">Rudder</button>
                    <button class="category-btn" onclick="filterAnodes('outboard')">Outboard</button>
                </div>
                
                <div id="anodeGrid" class="anode-grid">
                    <!-- Anodes will be populated here -->
                </div>
            </div>
            
            <div class="anodes-summary" id="anodesSummary">
                <!-- Print-friendly anode list -->
            </div>
        </div>
        
        <!-- Quote Summary -->
        <div class="quote-summary">
            <h2>Quote Summary</h2>
            
            <!-- Services Summary -->
            <div class="summary-section" id="servicesSummary" style="display: none;">
                <div class="summary-title">Services</div>
                <div id="servicesItems">
                    <!-- Service items will be listed here -->
                </div>
            </div>
            
            <!-- Anodes Summary -->
            <div class="summary-section" id="anodesSummarySection" style="display: none;">
                <div class="summary-title">Zinc Anodes</div>
                <div id="anodesItems">
                    <!-- Anode items will be listed here -->
                </div>
            </div>
            
            <!-- Totals -->
            <div class="quote-totals">
                <div class="total-row">
                    <span>Services Subtotal:</span>
                    <span id="servicesSubtotal">$0.00</span>
                </div>
                <div class="total-row">
                    <span>Anodes Subtotal:</span>
                    <span id="anodesSubtotal">$0.00</span>
                </div>
                <div class="total-row">
                    <span>Labor:</span>
                    <span id="laborTotal">$0.00</span>
                </div>
                <div class="total-row subtotal">
                    <span>Subtotal:</span>
                    <span id="subtotal">$0.00</span>
                </div>
                <div class="total-row">
                    <span>Tax (10.75%):</span>
                    <span id="taxTotal">$0.00</span>
                </div>
                <div class="total-row grand-total">
                    <span>Total Quote:</span>
                    <span id="grandTotal">$0.00</span>
                </div>
            </div>
        </div>
        
        <div class="quote-actions">
            <button class="action-btn btn-secondary" onclick="printQuote()">🖨️ Print Quote</button>
            <button class="action-btn btn-primary" onclick="saveQuote()">💾 Save Quote</button>
            <button class="action-btn btn-secondary" onclick="emailQuote()">📧 Email Quote</button>
        </div>
    </div>
    
    <script>
        // Service data
        const serviceData = {
            recurring_cleaning: { 
                rate: 4.50, 
                name: "Recurring Cleaning & Anodes", 
                type: 'per_foot',
                hasInterval: true
            },
            onetime_cleaning: { 
                rate: 6.00, 
                name: "One-time Cleaning & Anodes", 
                type: 'per_foot'
            },
            item_recovery: { 
                rate: 199, 
                name: "Item Recovery", 
                type: 'flat'
            },
            underwater_inspection: { 
                rate: 4, 
                name: "Underwater Inspection", 
                type: 'per_foot',
                minimum: 150
            },
            propeller_service: {
                rate: 349,
                name: "Propeller Removal/Installation",
                type: 'flat',
                hasTwinEngines: true
            }
        };
        
        let anodeCatalog = [];
        let anodeCart = {};
        let selectedServices = {};
        let currentFilter = 'all';
        let laborPerAnode = 15;
        let taxRate = 0.1075;
        let markupRate = 0.20;
        const minimumCharge = 150;
        
        // Initialize
        document.addEventListener('DOMContentLoaded', function() {
            // Set date and quote number
            const today = new Date();
            document.getElementById('quoteDate').value = today.toLocaleDateString();
            document.getElementById('quoteNumber').value = 'Q' + Date.now().toString().slice(-6);
            
            // Load anode catalog
            loadAnodeCatalog();
            
            // Set up service card clicks
            document.querySelectorAll('.service-card').forEach(card => {
                card.addEventListener('click', function() {
                    toggleService(this);
                });
            });
            
            // Check URL parameters
            const params = new URLSearchParams(window.location.search);
            
            // If loading from admin interface
            if (params.has('load') && params.get('load') === 'current') {
                const quoteData = localStorage.getItem('currentQuote');
                if (quoteData) {
                    const data = JSON.parse(quoteData);
                    
                    // Fill customer info
                    document.getElementById('customerName').value = data.customer || '';
                    document.getElementById('boatName').value = data.boat || '';
                    document.getElementById('boatLength').value = data.boatLength || '';
                    
                    // Select service if provided
                    if (data.service && data.service.key) {
                        const serviceCard = document.querySelector(`.service-card[data-service="${data.service.key}"]`);
                        if (serviceCard) {
                            serviceCard.click();
                        }
                    }
                    
                    // Load anodes into cart
                    if (data.anodes && data.anodes.length > 0) {
                        data.anodes.forEach(item => {
                            const anodeId = item.boatzincs_id || item.sku;
                            anodeCart[anodeId] = item;
                        });
                    }
                    
                    // Set pricing config
                    if (data.anodeConfig) {
                        taxRate = data.anodeConfig.taxRate / 100 || 0.1075;
                        laborPerAnode = data.anodeConfig.laborCharge || 15;
                        markupRate = data.anodeConfig.markupRate / 100 || 0.20;
                    }
                    
                    // Update display
                    setTimeout(() => {
                        displayAnodes();
                        updateQuoteSummary();
                    }, 500);
                }
            } else {
                if (params.has('customer')) {
                    document.getElementById('customerName').value = params.get('customer');
                }
                if (params.has('boat')) {
                    document.getElementById('boatName').value = params.get('boat');
                }
            }
        });
        
        function toggleService(card) {
            const serviceKey = card.dataset.service;
            
            if (card.classList.contains('selected')) {
                card.classList.remove('selected');
                delete selectedServices[serviceKey];
            } else {
                card.classList.add('selected');
                selectedServices[serviceKey] = {
                    ...serviceData[serviceKey],
                    quantity: 1,
                    interval: null,
                    twinEngines: false
                };
            }
            
            updateServiceOptions();
            updateQuoteSummary();
        }
        
        function updateServiceOptions() {
            const optionsDiv = document.getElementById('serviceOptions');
            const hasOptions = Object.keys(selectedServices).some(key => 
                serviceData[key].hasInterval || serviceData[key].hasTwinEngines
            );
            
            if (!hasOptions) {
                optionsDiv.style.display = 'none';
                return;
            }
            
            optionsDiv.style.display = 'block';
            let optionsHTML = '';
            
            for (const [key, service] of Object.entries(selectedServices)) {
                if (serviceData[key].hasInterval) {
                    optionsHTML += `
                        <div class="option-group">
                            <span class="option-label">Cleaning Interval:</span>
                            <div class="radio-group">
                                <label class="radio-item">
                                    <input type="radio" name="interval" value="monthly" onchange="setServiceInterval('${key}', 'monthly')">
                                    <span>Monthly</span>
                                </label>
                                <label class="radio-item">
                                    <input type="radio" name="interval" value="bimonthly" onchange="setServiceInterval('${key}', 'bimonthly')">
                                    <span>Bi-monthly</span>
                                </label>
                                <label class="radio-item">
                                    <input type="radio" name="interval" value="quarterly" onchange="setServiceInterval('${key}', 'quarterly')">
                                    <span>Quarterly</span>
                                </label>
                            </div>
                        </div>
                    `;
                }
                
                if (serviceData[key].hasTwinEngines) {
                    optionsHTML += `
                        <div class="option-group">
                            <div class="checkbox-item">
                                <input type="checkbox" id="twinEngines" onchange="setTwinEngines('${key}', this.checked)">
                                <label for="twinEngines">Twin Engines (2 propellers)</label>
                            </div>
                        </div>
                    `;
                }
            }
            
            optionsDiv.innerHTML = optionsHTML;
        }
        
        function setServiceInterval(serviceKey, interval) {
            if (selectedServices[serviceKey]) {
                selectedServices[serviceKey].interval = interval;
                updateQuoteSummary();
            }
        }
        
        function setTwinEngines(serviceKey, hasTwin) {
            if (selectedServices[serviceKey]) {
                selectedServices[serviceKey].quantity = hasTwin ? 2 : 1;
                updateQuoteSummary();
            }
        }
        
        function updateServicePrices() {
            updateQuoteSummary();
        }
        
        function toggleAnodeSection() {
            const content = document.getElementById('anodeContent');
            content.classList.toggle('collapsed');
        }
        
        async function loadAnodeCatalog() {
            try {
                let response = await fetch('/full-boatzincs-catalog.json');
                if (!response.ok) {
                    response = await fetch('/anode-catalog.json');
                }
                const data = await response.json();
                anodeCatalog = data.anodes || data;
                displayAnodes();
            } catch (error) {
                console.error('Failed to load catalog:', error);
            }
        }
        
        function filterAnodes(category) {
            currentFilter = category;
            
            document.querySelectorAll('.category-btn').forEach(btn => {
                btn.classList.remove('active');
            });
            event.target.classList.add('active');
            
            displayAnodes();
        }
        
        function displayAnodes() {
            const grid = document.getElementById('anodeGrid');
            
            let filtered = anodeCatalog;
            if (currentFilter !== 'all') {
                filtered = filtered.filter(anode => {
                    const cat = (anode.category || '').toLowerCase();
                    return cat.includes(currentFilter.toLowerCase());
                });
            }
            
            grid.innerHTML = filtered.slice(0, 50).map(anode => {
                const quantity = anodeCart[anode.boatzincs_id || anode.sku]?.quantity || 0;
                const price = typeof anode.list_price === 'string' ? 
                    parseFloat(anode.list_price.replace('$', '')) : 
                    anode.list_price;
                const markedUpPrice = price * (1 + markupRate);
                
                return `
                    <div class="anode-item">
                        <div class="anode-name">${anode.name}</div>
                        <div class="anode-controls">
                            <span class="anode-price">$${markedUpPrice.toFixed(2)}</span>
                            <div class="quantity-controls">
                                <button class="quantity-btn" onclick="updateAnodeQuantity('${anode.boatzincs_id || anode.sku}', -1)">-</button>
                                <span class="quantity-display">${quantity}</span>
                                <button class="quantity-btn" onclick="updateAnodeQuantity('${anode.boatzincs_id || anode.sku}', 1)">+</button>
                            </div>
                        </div>
                    </div>
                `;
            }).join('');
        }
        
        function updateAnodeQuantity(anodeId, change) {
            const anode = anodeCatalog.find(a => (a.boatzincs_id || a.sku) === anodeId);
            if (!anode) return;
            
            if (!anodeCart[anodeId]) {
                anodeCart[anodeId] = {
                    ...anode,
                    quantity: 0
                };
            }
            
            anodeCart[anodeId].quantity = Math.max(0, anodeCart[anodeId].quantity + change);
            
            if (anodeCart[anodeId].quantity === 0) {
                delete anodeCart[anodeId];
            }
            
            displayAnodes();
            updateQuoteSummary();
        }
        
        function updateQuoteSummary() {
            const boatLength = parseFloat(document.getElementById('boatLength').value) || 0;
            
            // Calculate services
            let servicesTotal = 0;
            const servicesItemsDiv = document.getElementById('servicesItems');
            const servicesSummaryDiv = document.getElementById('servicesSummary');
            
            if (Object.keys(selectedServices).length > 0 && boatLength > 0) {
                let servicesHTML = '';
                
                for (const [key, service] of Object.entries(selectedServices)) {
                    let price = 0;
                    let description = service.name;
                    
                    if (service.type === 'flat') {
                        price = service.rate * service.quantity;
                        if (service.quantity > 1) {
                            description += ` (x${service.quantity})`;
                        }
                    } else {
                        price = service.rate * boatLength;
                        if (service.minimum && price < service.minimum) {
                            price = service.minimum;
                        }
                        description += ` (${boatLength}ft)`;
                    }
                    
                    if (service.interval) {
                        description += ` - ${service.interval}`;
                    }
                    
                    servicesTotal += price;
                    
                    servicesHTML += `
                        <div class="quote-item">
                            <span>${description}</span>
                            <span>$${price.toFixed(2)}</span>
                        </div>
                    `;
                }
                
                servicesItemsDiv.innerHTML = servicesHTML;
                servicesSummaryDiv.style.display = 'block';
            } else {
                servicesSummaryDiv.style.display = 'none';
            }
            
            // Calculate anodes
            const anodeItems = Object.values(anodeCart);
            let anodesTotal = 0;
            let totalAnodeQuantity = 0;
            const anodesItemsDiv = document.getElementById('anodesItems');
            const anodesSummaryDiv = document.getElementById('anodesSummarySection');
            
            if (anodeItems.length > 0) {
                let anodesHTML = '';
                
                for (const item of anodeItems) {
                    const price = typeof item.list_price === 'string' ? 
                        parseFloat(item.list_price.replace('$', '')) : 
                        item.list_price;
                    const markedUpPrice = price * (1 + markupRate);
                    const lineTotal = markedUpPrice * item.quantity;
                    
                    anodesTotal += lineTotal;
                    totalAnodeQuantity += item.quantity;
                    
                    anodesHTML += `
                        <div class="quote-item">
                            <span>${item.quantity}x ${item.name}</span>
                            <span>$${lineTotal.toFixed(2)}</span>
                        </div>
                    `;
                }
                
                anodesItemsDiv.innerHTML = anodesHTML;
                anodesSummaryDiv.style.display = 'block';
            } else {
                anodesSummaryDiv.style.display = 'none';
            }
            
            // Calculate labor for anodes
            const laborTotal = totalAnodeQuantity * laborPerAnode;
            
            // Calculate totals
            const subtotal = servicesTotal + anodesTotal + laborTotal;
            const tax = subtotal * taxRate;
            const grandTotal = subtotal + tax;
            
            // Update display
            document.getElementById('servicesSubtotal').textContent = `$${servicesTotal.toFixed(2)}`;
            document.getElementById('anodesSubtotal').textContent = `$${anodesTotal.toFixed(2)}`;
            document.getElementById('laborTotal').textContent = totalAnodeQuantity > 0 ? 
                `$${laborTotal.toFixed(2)} (${totalAnodeQuantity} anodes)` : '$0.00';
            document.getElementById('subtotal').textContent = `$${subtotal.toFixed(2)}`;
            document.getElementById('taxTotal').textContent = `$${tax.toFixed(2)}`;
            document.getElementById('grandTotal').textContent = `$${grandTotal.toFixed(2)}`;
        }
        
        function printQuote() {
            // Prepare print view
            const anodesSummaryDiv = document.getElementById('anodesSummary');
            const anodeItems = Object.values(anodeCart);
            
            if (anodeItems.length > 0) {
                let summaryHTML = '<h3>Zinc Anodes</h3><ul>';
                for (const item of anodeItems) {
                    summaryHTML += `<li>${item.quantity}x ${item.name}</li>`;
                }
                summaryHTML += '</ul>';
                anodesSummaryDiv.innerHTML = summaryHTML;
            }
            
            window.print();
        }
        
        function saveQuote() {
            const quote = {
                quoteNumber: document.getElementById('quoteNumber').value,
                date: document.getElementById('quoteDate').value,
                customer: document.getElementById('customerName').value,
                boat: document.getElementById('boatName').value,
                boatLength: document.getElementById('boatLength').value,
                marina: document.getElementById('marina').value,
                services: selectedServices,
                anodes: Object.values(anodeCart),
                totals: {
                    services: document.getElementById('servicesSubtotal').textContent,
                    anodes: document.getElementById('anodesSubtotal').textContent,
                    labor: document.getElementById('laborTotal').textContent,
                    tax: document.getElementById('taxTotal').textContent,
                    total: document.getElementById('grandTotal').textContent
                }
            };
            
            const dataStr = JSON.stringify(quote, null, 2);
            const dataUri = 'data:application/json;charset=utf-8,'+ encodeURIComponent(dataStr);
            
            const exportFileDefaultName = `quote-${quote.quoteNumber}.json`;
            
            const linkElement = document.createElement('a');
            linkElement.setAttribute('href', dataUri);
            linkElement.setAttribute('download', exportFileDefaultName);
            linkElement.click();
            
            alert('Quote saved successfully!');
        }
        
        function emailQuote() {
            const customer = document.getElementById('customerName').value;
            const quoteNumber = document.getElementById('quoteNumber').value;
            const total = document.getElementById('grandTotal').textContent;
            
            const subject = `Sailor Skills Quote ${quoteNumber}`;
            const body = `Dear ${customer || 'Customer'},\n\nYour quote total is ${total}.\n\nPlease print this page for full details.\n\nThank you for your business!`;
            
            window.location.href = `mailto:?subject=${encodeURIComponent(subject)}&body=${encodeURIComponent(body)}`;
        }
    </script>
</body>
</html>